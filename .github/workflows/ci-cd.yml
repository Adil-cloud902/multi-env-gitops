name: CI/CD Pipeline - PHP App

on:
  push:
    branches: ["main"]  # le pipeline s'exécute à chaque push sur la branche "main"

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest  # environnement Linux

    steps:
      # 1️⃣ Récupérer le code du dépôt
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Lancer le linter PHP pour vérifier les erreurs de syntaxe
      - name: PHP Syntax Check
        run: find . -name "*.php" -exec php -l {} \;

      # 3️⃣ Construire l’image Docker
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/php-app:${{ github.run_number }} .
          docker tag ${{ secrets.DOCKER_USERNAME }}/php-app:${{ github.run_number }} ${{ secrets.DOCKER_USERNAME }}/php-app:latest

      # 4️⃣ Connexion à Docker Hub (via secrets GitHub)
      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 5️⃣ Pousser l’image Docker
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/php-app:${{ github.run_number }}
          docker push ${{ secrets.DOCKER_USERNAME }}/php-app:latest
